import pandas as pd
import logging
from pathlib import Path
from datetime import datetime, timedelta
import locale
import re
import numpy as np
from openpyxl import load_workbook
from openpyxl.styles import PatternFill, Font, Alignment, Border, Side, NamedStyle
from openpyxl.utils import get_column_letter
from openpyxl.chart import BarChart, LineChart, Reference, Series
from openpyxl.chart.label import DataLabelList
from openpyxl.chart.axis import DateAxis
from openpyxl.formatting.rule import DataBarRule, ColorScaleRule, IconSetRule

# =========================
# LOGGING
# =========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# =========================
# CONFIGURACI√ìN
# =========================
BASE_PATH = Path("c:/Copia-reporte-Aclarabot")
EXCEL_PATH = BASE_PATH / "archivos_Excel"
EXCEL_PATH.mkdir(exist_ok=True)

CSV_FILE = next(BASE_PATH.glob("Acumulado_filtrado_*.csv"))

# Locale espa√±ol (solo para nombre del archivo)
try:
    locale.setlocale(locale.LC_TIME, "Spanish_Spain")
except:
    try:
        locale.setlocale(locale.LC_TIME, "es_ES")
    except:
        logger.warning("‚ö†Ô∏è Locale espa√±ol no disponible")

HOY = datetime.now()
FECHA_TEXTO = HOY.strftime("%d-%B").capitalize()
OUTPUT_FILE = EXCEL_PATH / f"Reporte_Aclarapp_{FECHA_TEXTO}.xlsx"

# =========================
# COLUMNAS DE SALIDA
# =========================
COLUMNAS_SALIDA = [
    "Fecha",
    "Tipo de tarjeta",
    "Tipo de aclaracion",
    "Detalles de aclaracion",
    "Cargos",
    "RobotID",
    "AclaracionID",
    "Estatus",
    "Registro",
    "Folio",
    "CIS",
    "Fecha Creacion",
    "Fecha Enviado",
    "Fecha Asignacion",
    "Fecha Atendido",
    "Tiempo de captura agente",
    "Tiempo de alta robot",
    "Tiempo de captura agente segundos",
    "Tiempo de alta robot segundos",
    "Categoria tiempo agente",
    "Categoria tiempo Alta robot",
    "Numero de cargos",
    "Categoria de cargos",
    "Nombre Agente",
    "Supervisor",
    "Site",
    "Skill"
]

# =========================
# FUNCIONES AUXILIARES
# =========================
def convertir_columna_fecha(df, columna):
    """
    Convierte una columna de fecha de formato yyyy-MM-dd HH:mm:ss a datetime
    """
    if columna not in df.columns:
        logger.warning(f"‚ö†Ô∏è Columna '{columna}' no encontrada")
        return df
    
    logger.info(f"üîÑ Convirtiendo columna: {columna}")
    
    valores_antes = df[columna].notna().sum()
    
    if valores_antes == 0:
        logger.info("  ‚ö†Ô∏è No hay valores para convertir")
        return df
    
    try:
        # Intentar convertir del formato yyyy-MM-dd HH:mm:ss
        df[columna] = pd.to_datetime(
            df[columna],
            format='%Y-%m-%d %H:%M:%S',
            errors='coerce'
        )
        
        valores_despues = df[columna].notna().sum()
        logger.info(f"  Valores convertidos: {valores_despues}/{valores_antes}")
        
        if valores_despues < valores_antes:
            no_convertidos = valores_antes - valores_despues
            logger.warning(f"  ‚ö†Ô∏è {no_convertidos} valores no se pudieron convertir")
        
    except Exception as e:
        logger.error(f"‚ùå Error convirtiendo {columna}: {e}")
        df[columna] = pd.to_datetime(df[columna], errors='coerce')
    
    return df

def calcular_tiempo_en_minutos_segundos(segundos_totales):
    """
    Convierte segundos a formato mm:ss
    """
    if pd.isna(segundos_totales) or segundos_totales < 0:
        return None
    
    minutos = int(segundos_totales // 60)
    segundos = int(segundos_totales % 60)
    
    return f"{minutos:02d}:{segundos:02d}"

def categorizar_tiempo_agente(segundos):
    """
    Categoriza el tiempo de captura agente (formato exacto solicitado)
    """
    if pd.isna(segundos) or segundos < 0:
        return None
    
    if segundos < 60:
        return "menos de 1 min"
    elif segundos <= 90:
        return "menos de 1min 30seg"
    elif segundos <= 180:
        return "1min 30seg a 3min"
    elif segundos <= 300:
        return "3min a 5min"
    elif segundos <= 600:
        return "5min a 10min"
    else:  # > 600
        return "m√°s de 10min"

def categorizar_tiempo_alta_robot(segundos):
    """
    Categoriza el tiempo de alta robot (formato exacto solicitado)
    CON NUEVA CATEGOR√çA: Intervenci√≥n manual para > 25min (1500 seg)
    """
    if pd.isna(segundos) or segundos < 0:
        return None
    
    # 25 minutos = 1500 segundos
    if segundos > 1500:  # > 25 minutos
        return "Intervenci√≥n manual (> 25min)"
    elif segundos <= 60:
        return "menos de 1min"
    elif segundos <= 90:
        return "1min a 1min 30seg"
    elif segundos <= 180:
        return "1min 30seg a 3min"
    elif segundos <= 300:
        return "3min a 5min"
    elif segundos <= 600:
        return "5min a 10min"
    elif segundos <= 900:
        return "10min a 15min"
    elif segundos <= 1200:
        return "15min a 20min"
    else:  # 1201-1500 segundos (20-25min)
        return "20min a 25min"

def categorizar_numero_cargos(num_cargos):
    """
    Categoriza el n√∫mero de cargos (formato consistente)
    """
    if pd.isna(num_cargos) or num_cargos <= 0:
        return None
    
    num_cargos_int = int(num_cargos)
    
    if num_cargos_int == 1:
        return "1 cargo"
    elif 2 <= num_cargos_int <= 5:
        return "2 a 5 cargos"
    elif 6 <= num_cargos_int <= 10:
        return "6 a 10 cargos"
    elif 11 <= num_cargos_int <= 20:
        return "11 a 20 cargos"
    elif 21 <= num_cargos_int <= 30:
        return "21 a 30 cargos"
    elif 31 <= num_cargos_int <= 40:
        return "31 a 40 cargos"
    elif 41 <= num_cargos_int <= 50:
        return "41 a 50 cargos"
    elif 51 <= num_cargos_int <= 60:
        return "51 a 60 cargos"
    elif 61 <= num_cargos_int <= 70:
        return "61 a 70 cargos"
    elif 71 <= num_cargos_int <= 80:
        return "71 a 80 cargos"
    elif 81 <= num_cargos_int <= 90:
        return "81 a 90 cargos"
    elif 91 <= num_cargos_int <= 100:
        return "91 a 100 cargos"
    else:  # > 100
        return "m√°s de 100 cargos"

def crear_hoja_comparativa_agentes(workbook, df):
    """
    Crea hoja 'Comparativa Agentes' con dos tablas:
    1. Por Site
    2. Por Nombre Agente
    """
    logger.info("\nüìä CREANDO HOJA 'COMPARATIVA AGENTES'...")
    
    # Crear nueva hoja
    ws = workbook.create_sheet(title="Comparativa Agentes")
    
    # Verificar que tenemos los datos necesarios
    if "Fecha" not in df.columns or "Site" not in df.columns or "Nombre Agente" not in df.columns:
        logger.warning("‚ö†Ô∏è Datos insuficientes para crear hoja 'Comparativa Agentes'")
        ws["A1"] = "Datos insuficientes"
        return
    
    # Crear copia del DataFrame para procesar
    df_comparativa = df[["Fecha", "Site", "Nombre Agente"]].copy()
    
    # Extraer solo la fecha (sin hora) y convertir a formato dia-mes
    df_comparativa["Fecha"] = pd.to_datetime(df_comparativa["Fecha"]).dt.date
    
    # Ordenar por fecha
    df_comparativa = df_comparativa.sort_values("Fecha")
    
    # Obtener todas las fechas √∫nicas y formatearlas
    fechas_unicas = sorted(df_comparativa["Fecha"].unique())
    fechas_formateadas = [fecha.strftime("%d-%b") for fecha in fechas_unicas]
    
    # Reemplazar valores NaN en Site y Nombre Agente
    df_comparativa["Site"] = df_comparativa["Site"].fillna("Sin Site")
    df_comparativa["Nombre Agente"] = df_comparativa["Nombre Agente"].fillna("Sin Agente")
    
    # ============================================
    # TABLA 1: POR SITE
    # ============================================
    logger.info("üìà Creando tabla por Site...")
    
    # Crear tabla pivote para Site
    pivot_site = pd.pivot_table(
        df_comparativa,
        index="Site",
        columns="Fecha",
        aggfunc="size",
        fill_value=0
    )
    
    # Reordenar columnas por fecha
    pivot_site = pivot_site[fechas_unicas]
    
    # Renombrar columnas con formato dia-mes
    pivot_site.columns = fechas_formateadas
    
    # Calcular total por site
    pivot_site["Total"] = pivot_site.sum(axis=1)
    
    # Ordenar por total descendente
    pivot_site = pivot_site.sort_values("Total", ascending=False)
    
    # Escribir tabla por Site en Excel
    fila_actual = 1
    
    # T√≠tulo de la tabla
    ws.cell(row=fila_actual, column=1, value="COMPARATIVA POR SITE")
    ws.cell(row=fila_actual, column=1).font = Font(name="Calibri", size=14, bold=True, color="C00000")
    fila_actual += 1
    
    # Encabezados de tabla
    ws.cell(row=fila_actual, column=1, value="Site")
    for i, fecha in enumerate(fechas_formateadas, start=2):
        ws.cell(row=fila_actual, column=i, value=fecha)
    ws.cell(row=fila_actual, column=len(fechas_formateadas)+2, value="Total")
    
    # Formato encabezados
    for col in range(1, len(fechas_formateadas)+3):
        celda = ws.cell(row=fila_actual, column=col)
        celda.fill = PatternFill(start_color="C00000", end_color="C00000", fill_type="solid")
        celda.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
        celda.alignment = Alignment(horizontal="center", vertical="center")
    
    fila_actual += 1
    
    # Escribir datos de Site
    for site_idx, (site, fila) in enumerate(pivot_site.iterrows(), start=0):
        ws.cell(row=fila_actual, column=1, value=site)
        
        # Datos por fecha
        for fecha_idx, fecha in enumerate(fechas_formateadas, start=2):
            valor = int(fila[fecha])
            ws.cell(row=fila_actual, column=fecha_idx, value=valor)
        
        # Total
        ws.cell(row=fila_actual, column=len(fechas_formateadas)+2, value=int(fila["Total"]))
        fila_actual += 1
    
    # Guardar posici√≥n final de tabla Site
    fin_tabla_site = fila_actual - 1
    num_sites = len(pivot_site)
    
    # ============================================
    # TABLA 2: POR NOMBRE AGENTE
    # ============================================
    logger.info("üë§ Creando tabla por Nombre Agente...")
    
    # Crear tabla pivote para Nombre Agente
    pivot_agente = pd.pivot_table(
        df_comparativa,
        index="Nombre Agente",
        columns="Fecha",
        aggfunc="size",
        fill_value=0
    )
    
    # Reordenar columnas por fecha
    pivot_agente = pivot_agente[fechas_unicas]
    
    # Renombrar columnas con formato dia-mes
    pivot_agente.columns = fechas_formateadas
    
    # Calcular total por agente
    pivot_agente["Total"] = pivot_agente.sum(axis=1)
    
    # Ordenar por total descendente
    pivot_agente = pivot_agente.sort_values("Total", ascending=False)
    
    # Dejar espacio entre tablas
    fila_actual += 3
    
    # T√≠tulo de la tabla
    ws.cell(row=fila_actual, column=1, value="COMPARATIVA POR AGENTE")
    ws.cell(row=fila_actual, column=1).font = Font(name="Calibri", size=14, bold=True, color="C00000")
    fila_actual += 1
    
    # Encabezados de tabla
    ws.cell(row=fila_actual, column=1, value="Agente")
    for i, fecha in enumerate(fechas_formateadas, start=2):
        ws.cell(row=fila_actual, column=i, value=fecha)
    ws.cell(row=fila_actual, column=len(fechas_formateadas)+2, value="Total")
    
    # Formato encabezados
    for col in range(1, len(fechas_formateadas)+3):
        celda = ws.cell(row=fila_actual, column=col)
        celda.fill = PatternFill(start_color="C00000", end_color="C00000", fill_type="solid")
        celda.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
        celda.alignment = Alignment(horizontal="center", vertical="center")
    
    fila_actual += 1
    
    # Escribir datos de Agente
    for agente_idx, (agente, fila) in enumerate(pivot_agente.iterrows(), start=0):
        ws.cell(row=fila_actual, column=1, value=agente)
        
        # Datos por fecha
        for fecha_idx, fecha in enumerate(fechas_formateadas, start=2):
            valor = int(fila[fecha])
            ws.cell(row=fila_actual, column=fecha_idx, value=valor)
        
        # Total
        ws.cell(row=fila_actual, column=len(fechas_formateadas)+2, value=int(fila["Total"]))
        fila_actual += 1
    
    # Guardar posici√≥n final de tabla Agente
    inicio_tabla_agente = fila_actual - len(pivot_agente)
    fin_tabla_agente = fila_actual - 1
    num_agentes = len(pivot_agente)
    
    # ============================================
    # APLICAR FORMATOS CONDICIONALES
    # ============================================
    logger.info("üé® Aplicando formatos condicionales...")
    
    # Aplicar barras de datos degradadas rojas a ambas tablas
    # Color rojo degradado: FF6666 (claro) a C00000 (oscuro)
    
    # Para tabla Site
    inicio_datos_site = fin_tabla_site - num_sites + 1
    inicio_datos_agente = inicio_tabla_agente + 1
    
    # Definir regla de barras de datos rojas
    data_bar_rule = DataBarRule(
        start_type="min",
        start_value=0,
        end_type="max",
        end_value=None,
        color="FF6666"  # Rojo claro para el degradado
    )
    
    # Aplicar a todas las columnas de fechas en tabla Site
    for col_idx in range(2, len(fechas_formateadas) + 2):  # Columnas B en adelante
        col_letter = get_column_letter(col_idx)
        rango_site = f"{col_letter}{inicio_datos_site}:{col_letter}{fin_tabla_site}"
        ws.conditional_formatting.add(rango_site, data_bar_rule)
    
    # Aplicar a columna Total de Site
    col_total_site = get_column_letter(len(fechas_formateadas) + 2)
    rango_total_site = f"{col_total_site}{inicio_datos_site}:{col_total_site}{fin_tabla_site}"
    
    # Para total usar una regla diferente (m√°s oscura)
    data_bar_total_rule = DataBarRule(
        start_type="min",
        start_value=0,
        end_type="max",
        end_value=None,
        color="C00000"  # Rojo HSBC m√°s oscuro
    )
    ws.conditional_formatting.add(rango_total_site, data_bar_total_rule)
    
    # Aplicar a todas las columnas de fechas en tabla Agente
    for col_idx in range(2, len(fechas_formateadas) + 2):  # Columnas B en adelante
        col_letter = get_column_letter(col_idx)
        rango_agente = f"{col_letter}{inicio_datos_agente}:{col_letter}{fin_tabla_agente}"
        ws.conditional_formatting.add(rango_agente, data_bar_rule)
    
    # Aplicar a columna Total de Agente
    col_total_agente = get_column_letter(len(fechas_formateadas) + 2)
    rango_total_agente = f"{col_total_agente}{inicio_datos_agente}:{col_total_agente}{fin_tabla_agente}"
    ws.conditional_formatting.add(rango_total_agente, data_bar_total_rule)
    
    # ============================================
    # APLICAR FORMATO DE TABLA
    # ============================================
    
    # Definir bordes
    thin_border = Border(
        left=Side(style='thin'),
        right=Side(style='thin'),
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )
    
    # Aplicar bordes a tabla Site
    for row in range(inicio_datos_site - 1, fin_tabla_site + 1):  # Incluye encabezado
        for col in range(1, len(fechas_formateadas) + 3):
            ws.cell(row=row, column=col).border = thin_border
    
    # Aplicar bordes a tabla Agente
    for row in range(inicio_datos_agente - 1, fin_tabla_agente + 1):  # Incluye encabezado
        for col in range(1, len(fechas_formateadas) + 3):
            ws.cell(row=row, column=col).border = thin_border
    
    # Ajustar alineaci√≥n y formato de celdas
    for row in ws.iter_rows(min_row=1, max_row=fin_tabla_agente, min_col=1, max_col=len(fechas_formateadas)+3):
        for cell in row:
            if cell.column > 1:  # Todas las columnas excepto la primera (Site/Agente)
                cell.alignment = Alignment(horizontal="center", vertical="center")
                if cell.value and isinstance(cell.value, (int, float)):
                    cell.number_format = '#,##0'
            else:
                cell.alignment = Alignment(horizontal="left", vertical="center")
    
    # ============================================
    # AJUSTAR ANCHO DE COLUMNAS
    # ============================================
    
    # Para la primera columna (Site/Agente)
    ws.column_dimensions['A'].width = 25
    
    # Para columnas de fechas
    for col_idx in range(2, len(fechas_formateadas) + 2):
        col_letter = get_column_letter(col_idx)
        ws.column_dimensions[col_letter].width = 10
    
    # Para columna Total
    col_total = get_column_letter(len(fechas_formateadas) + 2)
    ws.column_dimensions[col_total].width = 12
    
    # ============================================
    # AGREGAR FILTROS
    # ============================================
    
    # Filtros para tabla Site
    ws.auto_filter.ref = f"A{inicio_datos_site - 1}:{col_total}{fin_tabla_site}"
    
    # Filtros para tabla Agente
    ws.auto_filter.ref = f"A{inicio_datos_agente - 1}:{col_total}{fin_tabla_agente}"
    
    # ============================================
    # AGREGAR INFORMACI√ìN DE RESUMEN
    # ============================================
    
    # Calcular totales generales
    total_general_site = pivot_site["Total"].sum()
    total_general_agente = pivot_agente["Total"].sum()
    
    # Mostrar resumen en log
    logger.info(f"‚úì Tabla por Site: {num_sites} sites, {len(fechas_formateadas)} d√≠as, {total_general_site} casos totales")
    logger.info(f"‚úì Tabla por Agente: {num_agentes} agentes, {len(fechas_formateadas)} d√≠as, {total_general_agente} casos totales")
    
    # Agregar nota al final del documento
    nota_fila = fin_tabla_agente + 3
    ws.cell(row=nota_fila, column=1, value="NOTAS:")
    ws.cell(row=nota_fila, column=1).font = Font(name="Calibri", size=10, bold=True, italic=True, color="666666")
    
    nota_fila += 1
    ws.cell(row=nota_fila, column=1, value="1. Las barras rojas degradadas muestran la distribuci√≥n de casos por d√≠a.")
    ws.cell(row=nota_fila, column=1).font = Font(name="Calibri", size=9, italic=True, color="666666")
    
    nota_fila += 1
    ws.cell(row=nota_fila, column=1, value="2. Use los filtros en los encabezados para ordenar o filtrar los datos.")
    ws.cell(row=nota_fila, column=1).font = Font(name="Calibri", size=9, italic=True, color="666666")
    
    nota_fila += 1
    ws.cell(row=nota_fila, column=1, value=f"3. Per√≠odo analizado: {fechas_formateadas[0]} al {fechas_formateadas[-1]} ({len(fechas_formateadas)} d√≠as)")
    ws.cell(row=nota_fila, column=1).font = Font(name="Calibri", size=9, italic=True, color="666666")
    
    logger.info("‚úÖ Hoja 'Comparativa Agentes' creada exitosamente")

def crear_hoja_tiempo_agente(workbook, df):
    """
    Crea hoja 'Tiempo agente' con tabla pivote y gr√°fica
    """
    logger.info("\nüìä CREANDO HOJA 'TIEMPO AGENTE'...")
    
    # Crear nueva hoja
    ws_agente = workbook.create_sheet(title="Tiempo agente")
    
    # Verificar que tenemos los datos necesarios
    if "Fecha" not in df.columns or "Categoria tiempo agente" not in df.columns:
        logger.warning("‚ö†Ô∏è Datos insuficientes para crear hoja 'Tiempo agente'")
        ws_agente["A1"] = "Datos insuficientes"
        return
    
    # Crear copia del DataFrame para procesar
    df_agente = df[["Fecha", "Categoria tiempo agente"]].copy()
    
    # Extraer solo la fecha (sin hora)
    df_agente["Fecha"] = pd.to_datetime(df_agente["Fecha"]).dt.date
    
    # Definir el orden de las categor√≠as
    categorias_orden = [
        "menos de 1 min",
        "menos de 1min 30seg", 
        "1min 30seg a 3min",
        "3min a 5min",
        "5min a 10min",
        "m√°s de 10min"
    ]
    
    # Crear tabla pivote
    pivot_agente = pd.pivot_table(
        df_agente,
        index="Fecha",
        columns="Categoria tiempo agente",
        aggfunc="size",
        fill_value=0
    )
    
    # Reindexar para asegurar todas las categor√≠as
    for cat in categorias_orden:
        if cat not in pivot_agente.columns:
            pivot_agente[cat] = 0
    
    # Ordenar columnas seg√∫n el orden definido
    pivot_agente = pivot_agente[categorias_orden]
    
    # Calcular total por d√≠a
    pivot_agente["Total"] = pivot_agente.sum(axis=1)
    
    # Ordenar por fecha (ascendente)
    pivot_agente = pivot_agente.sort_index()
    
    # Obtener √öLTIMOS 7 d√≠as (no primeros)
    if len(pivot_agente) > 0:
        ultima_fecha = pivot_agente.index.max()
        fecha_limite = ultima_fecha - timedelta(days=6)
        df_ultimos_7 = pivot_agente[pivot_agente.index >= fecha_limite].copy()
        logger.info(f"‚úì √öltimos 7 d√≠as: {len(df_ultimos_7)} d√≠as (desde {df_ultimos_7.index.min()} hasta {df_ultimos_7.index.max()})")
    else:
        df_ultimos_7 = pd.DataFrame()
        logger.warning("‚ö†Ô∏è No hay datos para crear tabla")
    
    logger.info(f"‚úì Tabla pivote creada: {len(pivot_agente)} d√≠as de datos")
    
    # Escribir encabezado en Excel
    ws_agente["A1"] = "Fecha"
    col = 2
    for categoria in categorias_orden:
        ws_agente.cell(row=1, column=col, value=categoria)
        col += 1
    ws_agente.cell(row=1, column=col, value="Total")
    
    # Escribir datos COMPLETOS (todos los d√≠as)
    for i, (fecha, fila) in enumerate(pivot_agente.iterrows(), start=2):
        ws_agente.cell(row=i, column=1, value=fecha)
        for j, categoria in enumerate(categorias_orden, start=2):
            ws_agente.cell(row=i, column=j, value=int(fila[categoria]))
        ws_agente.cell(row=i, column=len(categorias_orden)+2, value=int(fila["Total"]))
    
    # Aplicar formato a la tabla
    aplicar_formato_tabla_tiempos(ws_agente, len(pivot_agente), len(categorias_orden)+2)
    
    # Crear gr√°fica combinada (columnas apiladas + l√≠nea) con √öLTIMOS 7 d√≠as
    crear_grafica_combinada_tiempo_agente(workbook, ws_agente, df_ultimos_7, categorias_orden)
    
    # Agregar filtros a la tabla completa
    if len(pivot_agente) > 0:
        ws_agente.auto_filter.ref = f"A1:{get_column_letter(len(categorias_orden)+2)}{len(pivot_agente)+1}"
    
    logger.info("‚úÖ Hoja 'Tiempo agente' creada exitosamente")

def crear_hoja_tiempo_robot(workbook, df):
    """
    Crea hoja 'Tiempo robot' con tabla pivote y gr√°fica
    """
    logger.info("\nü§ñ CREANDO HOJA 'TIEMPO ROBOT'...")
    
    # Crear nueva hoja
    ws_robot = workbook.create_sheet(title="Tiempo robot")
    
    # Verificar que tenemos los datos necesarios
    if "Fecha" not in df.columns or "Categoria tiempo Alta robot" not in df.columns:
        logger.warning("‚ö†Ô∏è Datos insuficientes para crear hoja 'Tiempo robot'")
        ws_robot["A1"] = "Datos insuficientes"
        return
    
    # Crear copia del DataFrame para procesar
    df_robot = df[["Fecha", "Categoria tiempo Alta robot"]].copy()
    
    # Extraer solo la fecha (sin hora)
    df_robot["Fecha"] = pd.to_datetime(df_robot["Fecha"]).dt.date
    
    # Definir el orden de las categor√≠as
    categorias_orden = [
        "menos de 1min",
        "1min a 1min 30seg",
        "1min 30seg a 3min",
        "3min a 5min",
        "5min a 10min",
        "10min a 15min",
        "15min a 20min",
        "20min a 25min",
        "Intervenci√≥n manual (> 25min)"
    ]
    
    # Crear tabla pivote
    pivot_robot = pd.pivot_table(
        df_robot,
        index="Fecha",
        columns="Categoria tiempo Alta robot",
        aggfunc="size",
        fill_value=0
    )
    
    # Reindexar para asegurar todas las categor√≠as
    for cat in categorias_orden:
        if cat not in pivot_robot.columns:
            pivot_robot[cat] = 0
    
    # Ordenar columnas seg√∫n el orden definido
    pivot_robot = pivot_robot[categorias_orden]
    
    # Calcular total por d√≠a
    pivot_robot["Total"] = pivot_robot.sum(axis=1)
    
    # Ordenar por fecha (ascendente)
    pivot_robot = pivot_robot.sort_index()
    
    # Obtener √öLTIMOS 7 d√≠as (no primeros)
    if len(pivot_robot) > 0:
        ultima_fecha = pivot_robot.index.max()
        fecha_limite = ultima_fecha - timedelta(days=6)
        df_ultimos_7 = pivot_robot[pivot_robot.index >= fecha_limite].copy()
        logger.info(f"‚úì √öltimos 7 d√≠as: {len(df_ultimos_7)} d√≠as (desde {df_ultimos_7.index.min()} hasta {df_ultimos_7.index.max()})")
    else:
        df_ultimos_7 = pd.DataFrame()
        logger.warning("‚ö†Ô∏è No hay datos para crear tabla")
    
    logger.info(f"‚úì Tabla pivote creada: {len(pivot_robot)} d√≠as de datos")
    
    # Escribir encabezado en Excel
    ws_robot["A1"] = "Fecha"
    col = 2
    for categoria in categorias_orden:
        ws_robot.cell(row=1, column=col, value=categoria)
        col += 1
    ws_robot.cell(row=1, column=col, value="Total")
    
    # Escribir datos COMPLETOS (todos los d√≠as)
    for i, (fecha, fila) in enumerate(pivot_robot.iterrows(), start=2):
        ws_robot.cell(row=i, column=1, value=fecha)
        for j, categoria in enumerate(categorias_orden, start=2):
            ws_robot.cell(row=i, column=j, value=int(fila[categoria]))
        ws_robot.cell(row=i, column=len(categorias_orden)+2, value=int(fila["Total"]))
    
    # Aplicar formato a la tabla
    aplicar_formato_tabla_tiempos(ws_robot, len(pivot_robot), len(categorias_orden)+2)
    
    # Crear gr√°fica combinada (columnas apiladas + l√≠nea) con √öLTIMOS 7 d√≠as
    crear_grafica_combinada_tiempo_robot(workbook, ws_robot, df_ultimos_7, categorias_orden)
    
    # Agregar filtros a la tabla completa
    if len(pivot_robot) > 0:
        ws_robot.auto_filter.ref = f"A1:{get_column_letter(len(categorias_orden)+2)}{len(pivot_robot)+1}"
    
    logger.info("‚úÖ Hoja 'Tiempo robot' creada exitosamente")

def aplicar_formato_tabla_tiempos(worksheet, num_filas, num_columnas):
    """
    Aplica formato a las tablas de tiempos
    """
    # Formato de encabezados
    header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")  # Azul
    header_font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
    header_alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
    
    # Formato de datos
    data_font = Font(name="Calibri", size=10)
    data_alignment = Alignment(horizontal="center", vertical="center")
    
    # Bordes
    thin_border = Border(
        left=Side(style='thin'),
        right=Side(style='thin'),
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )
    
    # Aplicar formato a encabezados
    for col in range(1, num_columnas + 1):
        cell = worksheet.cell(row=1, column=col)
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = header_alignment
        cell.border = thin_border
    
    # Aplicar formato a datos
    for row in range(2, num_filas + 2):  # +2 porque row=1 es encabezado
        for col in range(1, num_columnas + 1):
            cell = worksheet.cell(row=row, column=col)
            cell.font = data_font
            cell.alignment = data_alignment
            cell.border = thin_border
    
    # Ajustar ancho de columnas
    for col in range(1, num_columnas + 1):
        column_letter = get_column_letter(col)
        max_length = 0
        for row in range(1, num_filas + 2):
            cell_value = worksheet.cell(row=row, column=col).value
            if cell_value:
                max_length = max(max_length, len(str(cell_value)))
        adjusted_width = min(max(max_length + 2, 10), 30)
        worksheet.column_dimensions[column_letter].width = adjusted_width

def crear_grafica_combinada_tiempo_agente(workbook, worksheet, df_ultimos_7, categorias_orden):
    """
    Crea gr√°fica combinada para tiempo agente con √öLTIMOS 7 d√≠as
    """
    if len(df_ultimos_7) == 0:
        logger.warning("‚ö†Ô∏è No hay datos para crear gr√°fica de tiempo agente")
        return
    
    # Crear gr√°fico de columnas apiladas
    chart = BarChart()
    chart.type = "col"  # Esto ya es para columnas
    chart.grouping = "stacked"  # ¬°IMPORTANTE! Apiladas
    chart.overlap = 100  # Para que las columnas se apilen completamente
    chart.style = 10
    chart.title = "Distribuci√≥n Tiempo Agente (√öltimos 7 d√≠as)"
    chart.y_axis.title = "Cantidad de Casos"
    chart.x_axis.title = "Fecha"
    chart.legend.position = "b"
    
    # Definir colores de verde a rojo
    colors_agente = [
        "92D050",  # Verde claro (menos de 1 min)
        "00B050",  # Verde
        "FFC000",  # Amarillo
        "FF6600",  # Naranja
        "FF3300",  # Rojo claro
        "C00000"   # Rojo oscuro (m√°s de 10min)
    ]
    
    # Obtener el rango de datos de los √∫ltimos 7 d√≠as en la hoja
    start_row = len(worksheet['A']) - len(df_ultimos_7) + 1  # √öltimas filas
    
    # Datos para las columnas (categor√≠as)
    for i, categoria in enumerate(categorias_orden):
        data = Reference(
            worksheet, 
            min_col=2 + i, 
            min_row=start_row, 
            max_row=len(worksheet['A'])
        )
        series = Series(data, title=categoria)
        series.graphicalProperties.solidFill = colors_agente[i]
        chart.series.append(series)
    
    # Crear gr√°fico de l√≠nea para el total
    line_chart = LineChart()
    line_chart.title = "Total de Casos"
    
    # Datos para la l√≠nea (total) - √∫ltima columna
    data_total = Reference(
        worksheet,
        min_col=len(categorias_orden) + 2,
        min_row=start_row,
        max_row=len(worksheet['A'])
    )
    
    series_total = Series(data_total, title="Total")
    series_total.graphicalProperties.line.solidFill = "000000"  # Negro
    series_total.graphicalProperties.line.width = 30000  # 3pt
    series_total.marker.symbol = "circle"
    series_total.marker.size = 8
    series_total.marker.graphicalProperties.solidFill = "000000"
    series_total.marker.graphicalProperties.line.solidFill = "000000"
    
    # Agregar etiquetas de datos a la l√≠nea
    series_total.dLbls = DataLabelList()
    series_total.dLbls.showVal = True
    series_total.dLbls.position = "t"  # Top
    
    # Combinar gr√°ficos
    chart.y_axis.majorGridlines = None
    chart += line_chart
    
    # Ajustar posici√≥n del eje X para que muestre las fechas correctamente
    dates = Reference(
        worksheet,
        min_col=1,
        min_row=start_row,
        max_row=len(worksheet['A'])
    )
    chart.set_categories(dates)
    
    # Posicionar gr√°fico a la derecha de la tabla
    chart_cell = get_column_letter(len(categorias_orden) + 5) + "2"
    worksheet.add_chart(chart, chart_cell)
    
    # Ajustar tama√±o de la gr√°fica
    chart.width = 30
    chart.height = 20
    
    # Agregar nota explicativa
    nota_cell = get_column_letter(len(categorias_orden) + 5) + "25"
    worksheet[nota_cell] = "NOTA: La gr√°fica muestra autom√°ticamente los √∫ltimos 7 d√≠as."
    worksheet[nota_cell].font = Font(name="Calibri", size=9, italic=True, color="666666")
    
    logger.info("‚úì Gr√°fica combinada de tiempo agente creada (columnas apiladas + l√≠nea)")

def crear_grafica_combinada_tiempo_robot(workbook, worksheet, df_ultimos_7, categorias_orden):
    """
    Crea gr√°fica combinada para tiempo robot con √öLTIMOS 7 d√≠as
    """
    if len(df_ultimos_7) == 0:
        logger.warning("‚ö†Ô∏è No hay datos para crear gr√°fica de tiempo robot")
        return
    
    # Crear gr√°fico de columnas apiladas
    chart = BarChart()
    chart.type = "col"  # Esto ya es para columnas
    chart.grouping = "stacked"  # ¬°IMPORTANTE! Apiladas
    chart.overlap = 100  # Para que las columnas se apilen completamente
    chart.style = 10
    chart.title = "Distribuci√≥n Tiempo Robot (√öltimos 7 d√≠as)"
    chart.y_axis.title = "Cantidad de Casos"
    chart.x_axis.title = "Fecha"
    chart.legend.position = "b"
    
    # Definir colores de verde a negro
    colors_robot = [
        "92D050",  # Verde claro (menos de 1min)
        "00B050",  # Verde
        "FFC000",  # Amarillo
        "FF9900",  # Naranja claro
        "FF6600",  # Naranja
        "FF3300",  # Rojo claro
        "C00000",  # Rojo
        "7F7F7F",  # Gris (20-25min)
        "000000"   # Negro (Intervenci√≥n manual)
    ]
    
    # Obtener el rango de datos de los √∫ltimos 7 d√≠as en la hoja
    start_row = len(worksheet['A']) - len(df_ultimos_7) + 1  # √öltimas filas
    
    # Datos para las columnas (categor√≠as)
    for i, categoria in enumerate(categorias_orden):
        data = Reference(
            worksheet, 
            min_col=2 + i, 
            min_row=start_row, 
            max_row=len(worksheet['A'])
        )
        series = Series(data, title=categoria)
        series.graphicalProperties.solidFill = colors_robot[i]
        chart.series.append(series)
    
    # Crear gr√°fico de l√≠nea para el total
    line_chart = LineChart()
    line_chart.title = "Total de Casos"
    
    # Datos para la l√≠nea (total) - √∫ltima columna
    data_total = Reference(
        worksheet,
        min_col=len(categorias_orden) + 2,
        min_row=start_row,
        max_row=len(worksheet['A'])
    )
    
    series_total = Series(data_total, title="Total")
    series_total.graphicalProperties.line.solidFill = "000000"  # Negro
    series_total.graphicalProperties.line.width = 30000  # 3pt
    series_total.marker.symbol = "circle"
    series_total.marker.size = 8
    series_total.marker.graphicalProperties.solidFill = "000000"
    series_total.marker.graphicalProperties.line.solidFill = "000000"
    
    # Agregar etiquetas de datos a la l√≠nea
    series_total.dLbls = DataLabelList()
    series_total.dLbls.showVal = True
    series_total.dLbls.position = "t"  # Top
    
    # Combinar gr√°ficos
    chart.y_axis.majorGridlines = None
    chart += line_chart
    
    # Ajustar posici√≥n del eje X para que muestre las fechas correctamente
    dates = Reference(
        worksheet,
        min_col=1,
        min_row=start_row,
        max_row=len(worksheet['A'])
    )
    chart.set_categories(dates)
    
    # Posicionar gr√°fico a la derecha de la tabla
    chart_cell = get_column_letter(len(categorias_orden) + 5) + "2"
    worksheet.add_chart(chart, chart_cell)
    
    # Ajustar tama√±o de la gr√°fica
    chart.width = 30
    chart.height = 20
    
    # Agregar nota explicativa
    nota_cell = get_column_letter(len(categorias_orden) + 5) + "25"
    worksheet[nota_cell] = "NOTA: La gr√°fica muestra autom√°ticamente los √∫ltimos 7 d√≠as."
    worksheet[nota_cell].font = Font(name="Calibri", size=9, italic=True, color="666666")
    
    logger.info("‚úì Gr√°fica combinada de tiempo robot creada (columnas apiladas + l√≠nea)")

def aplicar_formato_completo_excel(archivo_excel):
    """
    Aplica TODO el formato en una sola funci√≥n para evitar conflictos
    """
    logger.info("\nüé® APLICANDO FORMATO COMPLETO AL EXCEL...")
    
    try:
        # Cargar el workbook
        workbook = load_workbook(archivo_excel)
        
        # Primero procesar las nuevas hojas (si existen)
        if 'Tiempo agente' in workbook.sheetnames:
            logger.info("‚úì Hoja 'Tiempo agente' encontrada, aplicando formato...")
        
        if 'Tiempo robot' in workbook.sheetnames:
            logger.info("‚úì Hoja 'Tiempo robot' encontrada, aplicando formato...")
        
        # Ahora aplicar formato a la hoja 'Reporte'
        if 'Reporte' in workbook.sheetnames:
            worksheet = workbook['Reporte']
            
            # Encontrar √≠ndices de columnas
            columnas = [cell.value for cell in worksheet[1]]
            total_columnas = len(columnas)
            total_filas = worksheet.max_row
            
            logger.info(f"‚úì Workbook cargado: {total_filas} filas √ó {total_columnas} columnas")
            
            # ============================================
            # 1. PRIMERO: APLICAR FORMATO BASE A TODO EL DOCUMENTO
            # ============================================
            logger.info("\nüî§ APLICANDO FORMATO BASE (TIPOGRAF√çA Y BORDES BLANCOS)...")
            
            # Definir tipograf√≠a base
            try:
                # Intentar usar Univers Next, si no est√° disponible usar Calibri
                base_font = Font(name="Univers Next for HSBC Light", size=10)
                logger.info("   ‚úì Usando tipograf√≠a 'Univers Next for HSBC Light'")
            except:
                # Fallback a Calibri (similar sans-serif)
                base_font = Font(name="Calibri", size=10)
                logger.info("   ‚ö†Ô∏è 'Univers Next for HSBC Light' no disponible, usando 'Calibri' como alternativa")
            
            # Definir bordes BLANCOS
            white_border = Border(
                left=Side(style='thin', color="FFFFFF"),      # Blanco
                right=Side(style='thin', color="FFFFFF"),     # Blanco
                top=Side(style='thin', color="FFFFFF"),       # Blanco
                bottom=Side(style='thin', color="FFFFFF")     # Blanco
            )
            
            # Aplicar formato base a TODAS las celdas (incluyendo encabezados inicialmente)
            for row in worksheet.iter_rows(min_row=1, max_row=total_filas, min_col=1, max_col=total_columnas):
                for cell in row:
                    cell.font = base_font
                    cell.border = white_border
                    cell.alignment = Alignment(vertical="center")
            
            logger.info(f"   ‚úì Formato base aplicado a {total_filas} filas (bordes blancos)")
            
            # ============================================
            # 2. APLICAR FORMATO ESPEC√çFICO A ENCABEZADOS
            # ============================================
            logger.info("\nüî¥ APLICANDO FORMATO ESPECIAL A ENCABEZADOS...")
            
            # Definir estilo para encabezados
            header_fill = PatternFill(start_color="C00000", end_color="C00000", fill_type="solid")  # Rojo HSBC
            header_font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")  # Texto blanco, bold
            header_alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
            
            # Crear borde blanco especial para encabezados (m√°s grueso para mejor contraste)
            header_white_border = Border(
                left=Side(style='medium', color="FFFFFF"),      # Blanco m√°s grueso
                right=Side(style='medium', color="FFFFFF"),     # Blanco m√°s grueso
                top=Side(style='medium', color="FFFFFF"),       # Blanco m√°s grueso
                bottom=Side(style='medium', color="FFFFFF")     # Blanco m√°s grueso
            )
            
            # Aplicar formato a todos los encabezados (fila 1)
            for col in range(1, total_columnas + 1):
                cell = worksheet.cell(row=1, column=col)
                cell.fill = header_fill
                cell.font = header_font
                cell.alignment = header_alignment
                cell.border = header_white_border
            
            logger.info(f"   ‚úì Encabezados formateados: {total_columnas} columnas (fondo rojo, texto blanco, bordes blancos)")
            
            # ============================================
            # 3. APLICAR FORMATO CONDICIONAL (COLORES POR CATEGOR√çAS)
            # ============================================
            logger.info("\nüåà APLICANDO FORMATO CONDICIONAL POR CATEGOR√çAS...")
            
            # Encontrar √≠ndices de columnas objetivo
            idx_categoria_agente = None
            idx_categoria_robot = None
            idx_categoria_cargos = None
            
            for idx, col_name in enumerate(columnas, start=1):
                if col_name == "Categoria tiempo agente":
                    idx_categoria_agente = idx
                elif col_name == "Categoria tiempo Alta robot":
                    idx_categoria_robot = idx
                elif col_name == "Categoria de cargos":
                    idx_categoria_cargos = idx
            
            if idx_categoria_agente:
                logger.info(f"‚úì 'Categoria tiempo agente' en columna {get_column_letter(idx_categoria_agente)}")
            if idx_categoria_robot:
                logger.info(f"‚úì 'Categoria tiempo Alta robot' en columna {get_column_letter(idx_categoria_robot)}")
            if idx_categoria_cargos:
                logger.info(f"‚úì 'Categoria de cargos' en columna {get_column_letter(idx_categoria_cargos)}")
            
            # Definir colores para formato condicional
            fill_verde_claro = PatternFill(start_color="C6EFCE", end_color="C6EFCE", fill_type="solid")
            fill_verde = PatternFill(start_color="92D050", end_color="92D050", fill_type="solid")
            fill_amarillo_claro = PatternFill(start_color="FFEB9C", end_color="FFEB9C", fill_type="solid")
            fill_amarillo = PatternFill(start_color="FFC000", end_color="FFC000", fill_type="solid")
            fill_naranja = PatternFill(start_color="FF9966", end_color="FF9966", fill_type="solid")
            fill_rojo = PatternFill(start_color="FF6666", end_color="FF6666", fill_type="solid")
            fill_azul_claro = PatternFill(start_color="B4C6E7", end_color="B4C6E7", fill_type="solid")
            fill_azul = PatternFill(start_color="8EA9DB", end_color="8EA9DB", fill_type="solid")
            fill_negro = PatternFill(start_color="000000", end_color="000000", fill_type="solid")
            
            # Colores para categor√≠as de cargos
            fill_cargos_verde_claro = PatternFill(start_color="E2F0D9", end_color="E2F0D9", fill_type="solid")
            fill_cargos_verde = PatternFill(start_color="C5E0B4", end_color="C5E0B4", fill_type="solid")
            fill_cargos_amarillo = PatternFill(start_color="FFF2CC", end_color="FFF2CC", fill_type="solid")
            fill_cargos_naranja = PatternFill(start_color="F8CBAD", end_color="F8CBAD", fill_type="solid")
            fill_cargos_rojo = PatternFill(start_color="F2A7A7", end_color="F2A7A7", fill_type="solid")
            
            # Aplicar formato condicional a cada fila
            contador_formatos = 0
            
            for row in range(2, total_filas + 1):
                # Formato para Categor√≠a Tiempo Agente
                if idx_categoria_agente:
                    celda_agente = worksheet.cell(row=row, column=idx_categoria_agente)
                    valor_agente = celda_agente.value
                    
                    if valor_agente:
                        if valor_agente == "menos de 1 min":
                            celda_agente.fill = fill_verde_claro
                        elif valor_agente == "menos de 1min 30seg":
                            celda_agente.fill = fill_verde
                        elif valor_agente == "1min 30seg a 3min":
                            celda_agente.fill = fill_amarillo_claro
                        elif valor_agente == "3min a 5min":
                            celda_agente.fill = fill_amarillo
                        elif valor_agente == "5min a 10min":
                            celda_agente.fill = fill_naranja
                        elif valor_agente == "m√°s de 10min":
                            celda_agente.fill = fill_rojo
                        contador_formatos += 1
                
                # Formato para Categor√≠a Tiempo Robot
                if idx_categoria_robot:
                    celda_robot = worksheet.cell(row=row, column=idx_categoria_robot)
                    valor_robot = celda_robot.value
                    
                    if valor_robot:
                        if valor_robot == "menos de 1min":
                            celda_robot.fill = fill_verde_claro
                        elif valor_robot == "1min a 1min 30seg":
                            celda_robot.fill = fill_verde
                        elif valor_robot == "1min 30seg a 3min":
                            celda_robot.fill = fill_amarillo_claro
                        elif valor_robot == "3min a 5min":
                            celda_robot.fill = fill_amarillo
                        elif valor_robot == "5min a 10min":
                            celda_robot.fill = fill_naranja
                        elif valor_robot == "10min a 15min":
                            celda_robot.fill = fill_rojo
                        elif valor_robot == "15min a 20min":
                            celda_robot.fill = fill_azul_claro
                        elif valor_robot == "20min a 25min":
                            celda_robot.fill = fill_azul
                        elif valor_robot == "Intervenci√≥n manual (> 25min)":
                            celda_robot.fill = fill_negro
                            # Para celdas negras, mantener el texto blanco pero con la misma fuente base
                            celda_robot.font = Font(name=celda_robot.font.name, 
                                                   size=celda_robot.font.size, 
                                                   color="FFFFFF")
                        contador_formatos += 1
                
                # Formato para Categor√≠a de Cargos
                if idx_categoria_cargos:
                    celda_cargos = worksheet.cell(row=row, column=idx_categoria_cargos)
                    valor_cargos = celda_cargos.value
                    
                    if valor_cargos:
                        if valor_cargos == "1 cargo":
                            celda_cargos.fill = fill_cargos_verde_claro
                        elif valor_cargos == "2 a 5 cargos":
                            celda_cargos.fill = fill_cargos_verde
                        elif valor_cargos == "6 a 10 cargos":
                            celda_cargos.fill = fill_cargos_amarillo
                        elif valor_cargos in ["11 a 20 cargos", "21 a 30 cargos"]:
                            celda_cargos.fill = fill_cargos_naranja
                        else:
                            celda_cargos.fill = fill_cargos_rojo
                    contador_formatos += 1
            
            logger.info(f"   ‚úì Formato condicional aplicado a {contador_formatos} celdas (con bordes blancos preservados)")
            
            # ============================================
            # 4. APLICAR FORMATO ESPECIAL A COLUMNAS DE FECHA
            # ============================================
            logger.info("\nüìÖ APLICANDO FORMATO ESPECIAL A COLUMNAS DE FECHA...")
            
            # Identificar columnas de fecha
            columnas_fecha_keywords = ['fecha', 'Fecha', 'FECHA', 'creacion', 'Creacion', 'enviado', 'Enviado', 
                                      'asignacion', 'Asignacion', 'atendido', 'Atendido']
            
            columnas_fecha_indices = []
            
            for idx, col_name in enumerate(columnas, start=1):
                if any(keyword in str(col_name) for keyword in columnas_fecha_keywords):
                    columnas_fecha_indices.append(idx)
            
            if columnas_fecha_indices:
                logger.info(f"   Encontradas {len(columnas_fecha_indices)} columnas de fecha")
                
                # Aplicar formato de fecha a las columnas identificadas
                date_format = 'yyyy-mm-dd hh:mm:ss'
                
                for fecha_idx in columnas_fecha_indices:
                    col_letter = get_column_letter(fecha_idx)
                    
                    # Aplicar formato a todas las celdas en esta columna (excepto encabezado)
                    for row in range(2, total_filas + 1):
                        cell = worksheet.cell(row=row, column=fecha_idx)
                        # Solo aplicar formato si es una fecha/datetime
                        if isinstance(cell.value, (datetime, pd.Timestamp)):
                            cell.number_format = date_format
            
            # ============================================
            # 5. AJUSTAR ANCHO DE COLUMNAS
            # ============================================
            logger.info("\nüìè AJUSTANDO ANCHO DE COLUMNAS...")
            
            for i, col in enumerate(worksheet.columns, start=1):
                max_length = 0
                column_letter = get_column_letter(i)
                
                # Encontrar el texto m√°s largo en la columna
                for cell in col:
                    try:
                        cell_value = str(cell.value) if cell.value is not None else ""
                        # Considerar saltos de l√≠nea en el c√°lculo
                        lines = cell_value.split('\n')
                        for line in lines:
                            if len(line) > max_length:
                                max_length = len(line)
                    except:
                        pass
                
                # Ajustar ancho (m√≠nimo 10, m√°ximo 50)
                adjusted_width = min(max(max_length + 2, 10), 50)
                worksheet.column_dimensions[column_letter].width = adjusted_width
            
            logger.info("   ‚úì Ancho de columnas ajustado")
            
            # ============================================
            # 6. AJUSTAR ALTURA DE FILAS
            # ============================================
            logger.info("\nüìä AJUSTANDO ALTURA DE FILAS...")
            
            # Altura para encabezados
            worksheet.row_dimensions[1].height = 25
            
            # Altura para filas de datos
            for row in range(2, total_filas + 1):
                worksheet.row_dimensions[row].height = 20
            
            logger.info("   ‚úì Altura de filas ajustada")
            
            # ============================================
            # 7. AGREGAR FILTROS
            # ============================================
            logger.info("\nüîç AGREGANDO FILTROS AUTOM√ÅTICOS...")
            
            worksheet.auto_filter.ref = worksheet.dimensions
            
            logger.info("   ‚úì Filtros agregados")
            
            # ============================================
            # 8. CONGELAR PANELES
            # ============================================
            logger.info("\nüìå CONGELANDO PANELES...")
            
            worksheet.freeze_panes = "A2"
            
            logger.info("   ‚úì Paneles congelados (fila 1 fija)")
        
        # Guardar el workbook
        workbook.save(archivo_excel)
        logger.info(f"\n‚úÖ FORMATO COMPLETO APLICADO CORRECTAMENTE")
        logger.info(f"   üìÅ Archivo: {archivo_excel.name}")
        
    except Exception as e:
        logger.error(f"‚ùå Error aplicando formato completo: {e}")
        import traceback
        logger.error(f"Detalles: {traceback.format_exc()}")

def calcular_tiempos_agente_robot(df):
    """
    Calcula los tiempos de captura agente y alta robot
    """
    logger.info("\n‚è±Ô∏è CALCULANDO TIEMPOS...")
    
    # =========================
    # 1. TIEMPO DE CAPTURA AGENTE (Fecha Enviado - Fecha Creacion)
    # =========================
    logger.info("\nüîπ Tiempo de captura agente (Fecha Enviado - Fecha Creacion):")
    
    # Verificar columnas necesarias
    columnas_requeridas = ["Fecha Creacion", "Fecha Enviado"]
    for col in columnas_requeridas:
        if col not in df.columns:
            logger.error(f"‚ùå Columna '{col}' no encontrada para c√°lculo")
            return df
    
    # Calcular diferencia en segundos
    mask_fechas_validas = df["Fecha Creacion"].notna() & df["Fecha Enviado"].notna()
    total_filas_validas = mask_fechas_validas.sum()
    
    logger.info(f"  Filas con ambas fechas v√°lidas: {total_filas_validas}/{len(df)}")
    
    if total_filas_validas > 0:
        # Calcular diferencia en segundos
        df.loc[mask_fechas_validas, "Tiempo de captura agente segundos"] = (
            (df.loc[mask_fechas_validas, "Fecha Enviado"] - 
             df.loc[mask_fechas_validas, "Fecha Creacion"]).dt.total_seconds()
        )
        
        # Convertir a formato mm:ss
        df.loc[mask_fechas_validas, "Tiempo de captura agente"] = df.loc[
            mask_fechas_validas, "Tiempo de captura agente segundos"
        ].apply(calcular_tiempo_en_minutos_segundos)
        
        # Categorizar tiempo agente
        df.loc[mask_fechas_validas, "Categoria tiempo agente"] = df.loc[
            mask_fechas_validas, "Tiempo de captura agente segundos"
        ].apply(categorizar_tiempo_agente)
        
        # Estad√≠sticas
        segundos_no_nulos = df["Tiempo de captura agente segundos"].notna().sum()
        logger.info(f"  Tiempos calculados: {segundos_no_nulos}")
        
        if segundos_no_nulos > 0:
            # Mostrar distribuci√≥n de categor√≠as
            logger.info("  Distribuci√≥n de categor√≠as de tiempo agente:")
            categorias = df["Categoria tiempo agente"].value_counts()
            for categoria, count in categorias.items():
                if pd.notna(categoria):
                    logger.info(f"    {categoria}: {count}")
            
            # Mostrar un ejemplo
            idx_ejemplo = df[mask_fechas_validas].index[0]
            ejemplo = df.loc[idx_ejemplo]
            logger.info(f"  Ejemplo de c√°lculo:")
            logger.info(f"    Segundos: {ejemplo['Tiempo de captura agente segundos']:.0f}")
            logger.info(f"    Formato mm:ss: {ejemplo['Tiempo de captura agente']}")
            logger.info(f"    Categor√≠a: {ejemplo['Categoria tiempo agente']}")
        
        # Estad√≠sticas descriptivas
        if segundos_no_nulos > 0:
            min_seg = df["Tiempo de captura agente segundos"].min()
            max_seg = df["Tiempo de captura agente segundos"].max()
            mean_seg = df["Tiempo de captura agente segundos"].mean()
            
            logger.info(f"  Estad√≠sticas (segundos):")
            logger.info(f"    M√≠nimo: {min_seg:.0f}s")
            logger.info(f"    M√°ximo: {max_seg:.0f}s")
            logger.info(f"    Promedio: {mean_seg:.0f}s")
    else:
        logger.warning("  ‚ö†Ô∏è No hay filas con ambas fechas v√°lidas para calcular")
        df["Tiempo de captura agente"] = None
        df["Tiempo de captura agente segundos"] = None
        df["Categoria tiempo agente"] = None
    
    # =========================
    # 2. TIEMPO DE ALTA ROBOT (Fecha Atendido - Fecha Asignacion)
    # =========================
    logger.info("\nüîπ Tiempo de alta robot (Fecha Atendido - Fecha Asignacion):")
    logger.info("  NOTA: Nueva categor√≠a 'Intervenci√≥n manual' para tiempos > 25min (1500 seg)")
    
    # Verificar columnas necesarias
    columnas_requeridas = ["Fecha Asignacion", "Fecha Atendido"]
    for col in columnas_requeridas:
        if col not in df.columns:
            logger.error(f"‚ùå Columna '{col}' no encontrada para c√°lculo")
            return df
    
    # Calcular diferencia en segundos
    mask_fechas_validas = df["Fecha Asignacion"].notna() & df["Fecha Atendido"].notna()
    total_filas_validas = mask_fechas_validas.sum()
    
    logger.info(f"  Filas con ambas fechas v√°lidas: {total_filas_validas}/{len(df)}")
    
    if total_filas_validas > 0:
        # Calcular diferencia en segundos
        df.loc[mask_fechas_validas, "Tiempo de alta robot segundos"] = (
            (df.loc[mask_fechas_validas, "Fecha Atendido"] - 
             df.loc[mask_fechas_validas, "Fecha Asignacion"]).dt.total_seconds()
        )
        
        # Convertir a formato mm:ss
        df.loc[mask_fechas_validas, "Tiempo de alta robot"] = df.loc[
            mask_fechas_validas, "Tiempo de alta robot segundos"
        ].apply(calcular_tiempo_en_minutos_segundos)
        
        # Categorizar tiempo alta robot (con nueva categor√≠a)
        df.loc[mask_fechas_validas, "Categoria tiempo Alta robot"] = df.loc[
            mask_fechas_validas, "Tiempo de alta robot segundos"
        ].apply(categorizar_tiempo_alta_robot)
        
        # Estad√≠sticas
        segundos_no_nulos = df["Tiempo de alta robot segundos"].notna().sum()
        logger.info(f"  Tiempos calculados: {segundos_no_nulos}")
        
        if segundos_no_nulos > 0:
            # Mostrar distribuci√≥n de categor√≠as
            logger.info("  Distribuci√≥n de categor√≠as de tiempo alta robot (con nueva categor√≠a):")
            categorias = df["Categoria tiempo Alta robot"].value_counts()
            for categoria, count in categorias.items():
                if pd.notna(categoria):
                    logger.info(f"    {categoria}: {count}")
            
            # Contar espec√≠ficamente intervenciones manuales
            intervenciones = df[df["Categoria tiempo Alta robot"] == "Intervenci√≥n manual (> 25min)"].shape[0]
            logger.info(f"  Total casos de 'Intervenci√≥n manual (> 25min)': {intervenciones}")
            
            # Mostrar un ejemplo de intervenci√≥n manual si hay
            mask_intervencion = df["Categoria tiempo Alta robot"] == "Intervenci√≥n manual (> 25min)"
            if mask_intervencion.any():
                idx_ejemplo = df[mask_intervencion].index[0]
                ejemplo = df.loc[idx_ejemplo]
                logger.info(f"  Ejemplo de Intervenci√≥n manual:")
                logger.info(f"    Segundos: {ejemplo['Tiempo de alta robot segundos']:.0f}")
                logger.info(f"    Formato mm:ss: {ejemplo['Tiempo de alta robot']}")
                logger.info(f"    Categor√≠a: {ejemplo['Categoria tiempo Alta robot']}")
            else:
                # Mostrar cualquier ejemplo
                idx_ejemplo = df[mask_fechas_validas].index[0]
                ejemplo = df.loc[idx_ejemplo]
                logger.info(f"  Ejemplo de c√°lculo:")
                logger.info(f"    Segundos: {ejemplo['Tiempo de alta robot segundos']:.0f}")
                logger.info(f"    Formato mm:ss: {ejemplo['Tiempo de alta robot']}")
                logger.info(f"    Categor√≠a: {ejemplo['Categoria tiempo Alta robot']}")
        
        # Estad√≠sticas descriptivas
        if segundos_no_nulos > 0:
            min_seg = df["Tiempo de alta robot segundos"].min()
            max_seg = df["Tiempo de alta robot segundos"].max()
            mean_seg = df["Tiempo de alta robot segundos"].mean()
            
            logger.info(f"  Estad√≠sticas (segundos):")
            logger.info(f"    M√≠nimo: {min_seg:.0f}s")
            logger.info(f"    M√°ximo: {max_seg:.0f}s")
            logger.info(f"    Promedio: {mean_seg:.0f}s")
            
            # Estad√≠sticas espec√≠ficas para intervenciones manuales
            mask_intervencion = df["Categoria tiempo Alta robot"] == "Intervenci√≥n manual (> 25min)"
            if mask_intervencion.any():
                intervenciones_seg = df.loc[mask_intervencion, "Tiempo de alta robot segundos"]
                logger.info(f"  Estad√≠sticas de Intervenciones manuales:")
                logger.info(f"    Cantidad: {len(intervenciones_seg)} casos")
                logger.info(f"    Tiempo m√≠nimo: {intervenciones_seg.min():.0f}s")
                logger.info(f"    Tiempo m√°ximo: {intervenciones_seg.max():.0f}s")
                logger.info(f"    Tiempo promedio: {intervenciones_seg.mean():.0f}s")
    else:
        logger.warning("  ‚ö†Ô∏è No hay filas con ambas fechas v√°lidas para calcular")
        df["Tiempo de alta robot"] = None
        df["Tiempo de alta robot segundos"] = None
        df["Categoria tiempo Alta robot"] = None
    
    return df

def calcular_categorias_cargos(df):
    """
    Calcula la categor√≠a de cargos basada en la columna 'Cargos'
    """
    logger.info("\nüí∞ CALCULANDO CATEGOR√çAS DE CARGOS DESDE COLUMNA 'Cargos'...")
    
    # Primero, verificar si tenemos la columna 'Cargos'
    if "Cargos" not in df.columns:
        logger.warning("‚ö†Ô∏è Columna 'Cargos' no encontrada")
        
        # Tambi√©n verificar si hay 'Numero de cargos'
        if "Numero de cargos" in df.columns:
            logger.info("  Usando columna 'Numero de cargos' como alternativa...")
            columna_cargos = "Numero de cargos"
        else:
            logger.warning("  ‚ö†Ô∏è No se encontr√≥ ninguna columna de cargos")
            df["Numero de cargos"] = None
            df["Categoria de cargos"] = None
            return df
    else:
        columna_cargos = "Cargos"
    
    logger.info(f"  Usando columna: '{columna_cargos}'")
    
    # Convertir a num√©rico si no lo es
    if columna_cargos == "Cargos":
        # Crear columna 'Numero de cargos' a partir de 'Cargos'
        logger.info("  Convirtiendo 'Cargos' a num√©rico...")
        
        # Intentar diferentes conversiones
        df["Numero de cargos"] = pd.to_numeric(df[columna_cargos], errors='coerce')
        
        # Si falla la conversi√≥n directa, intentar extraer n√∫meros del texto
        if df["Numero de cargos"].isna().all():
            logger.info("  Intentando extraer n√∫meros del texto...")
            # Extraer n√∫meros del texto
            df["Numero de cargos"] = (
                df[columna_cargos]
                .astype(str)
                .str.extract(r'(\d+)')
                .astype(float)
            )
    
    # Calcular categor√≠as
    valores_no_nulos = df["Numero de cargos"].notna().sum()
    total_filas = len(df)
    
    logger.info(f"  Filas con n√∫mero de cargos v√°lido: {valores_no_nulos}/{total_filas}")
    
    if valores_no_nulos > 0:
        # Aplicar categorizaci√≥n
        df["Categoria de cargos"] = df["Numero de cargos"].apply(categorizar_numero_cargos)
        
        # Mostrar distribuci√≥n
        logger.info("  Distribuci√≥n de categor√≠as de cargos:")
        categorias = df["Categoria de cargos"].value_counts()
        for categoria, count in categorias.items():
            if pd.notna(categoria):
                logger.info(f"    {categoria}: {count}")
        
        # Mostrar estad√≠sticas
        min_cargos = df["Numero de cargos"].min()
        max_cargos = df["Numero de cargos"].max()
        mean_cargos = df["Numero de cargos"].mean()
        
        logger.info(f"  Estad√≠sticas de cargos:")
        logger.info(f"    M√≠nimo: {min_cargos:.0f}")
        logger.info(f"    M√°ximo: {max_cargos:.0f}")
        logger.info(f"    Promedio: {mean_cargos:.1f}")
        
        # Mostrar un ejemplo
        idx_ejemplo = df[df["Categoria de cargos"].notna()].index[0]
        ejemplo = df.loc[idx_ejemplo]
        logger.info(f"  Ejemplo:")
        logger.info(f"    Valor original en '{columna_cargos}': {ejemplo[columna_cargos]}")
        logger.info(f"    N√∫mero de cargos: {ejemplo['Numero de cargos']}")
        logger.info(f"    Categor√≠a: {ejemplo['Categoria de cargos']}")
        
        total_categorias = df["Categoria de cargos"].notna().sum()
        logger.info(f"  Total categorizados: {total_categorias}")
    else:
        logger.warning("  ‚ö†Ô∏è No hay valores v√°lidos para categorizar")
        df["Categoria de cargos"] = None
    
    return df

def procesar_y_crear_hojas_tiempos(df_final, archivo_excel):
    """
    Procesa los datos y crea las hojas de tiempos despu√©s del archivo inicial
    """
    logger.info("\nüìä PROCESANDO DATOS PARA HERRAMIENTAS DE TIEMPO...")
    
    try:
        # Cargar el workbook existente
        workbook = load_workbook(archivo_excel)
        
        # Crear hoja de tiempo agente
        crear_hoja_tiempo_agente(workbook, df_final)
        
        # Crear hoja de tiempo robot
        crear_hoja_tiempo_robot(workbook, df_final)
        
        # Crear hoja Comparativa Agentes (NUEVA)
        crear_hoja_comparativa_agentes(workbook, df_final)
        
        # Guardar los cambios
        workbook.save(archivo_excel)
        
        logger.info("‚úÖ Hojas de tiempo y comparativa creadas exitosamente")
        
    except Exception as e:
        logger.error(f"‚ùå Error creando hojas de tiempo: {e}")
        import traceback
        logger.error(f"Detalles: {traceback.format_exc()}")

# =========================
# MAIN
# =========================
def main():
    logger.info("üöÄ Generando Reporte Excel Aclarapp con c√°lculos de tiempo y categor√≠as")
    logger.info("üí° NUEVA CARACTER√çSTICA: An√°lisis de tiempos por d√≠a en hojas separadas")
    logger.info("üìä NUEVA CARACTER√çSTICA: Gr√°ficas de COLUMNAS APILADAS + l√≠nea")
    logger.info("üîß NUEVA CARACTER√çSTICA: Filtros en tablas para seleccionar rangos personalizados")
    logger.info("üìà NUEVA CARACTER√çSTICA: √öLTIMOS 7 d√≠as autom√°ticamente en gr√°ficas")
    logger.info("üë• NUEVA CARACTER√çSTICA: Hoja 'Comparativa Agentes' con an√°lisis por site y agente")

    # =========================
    # CARGA CSV
    # =========================
    df = pd.read_csv(CSV_FILE, dtype=str, encoding="utf-8-sig")
    logger.info(f"‚úì CSV cargado: {CSV_FILE.name} ({len(df)} filas)")
    
    # Mostrar primeras filas para diagn√≥stico
    logger.info("\nüîç PRIMERAS FILAS DEL CSV PARA DIAGN√ìSTICO:")
    logger.info(f"Columnas disponibles: {list(df.columns)}")

    # =========================
    # VERIFICAR COLUMNAS DE FECHA EXISTENTES
    # =========================
    logger.info("\nüîç VERIFICANDO COLUMNAS DE FECHA...")
    
    columnas_fecha = [
        "Fecha",
        "Fecha Creacion",  # Nota: en el CSV original es "Fecha Creaci√≥n" con acento
        "Fecha Enviado",
        "Fecha Asignacion",
        "Fecha Atendido"
    ]
    
    # Verificar qu√© columnas realmente existen
    columnas_existentes = []
    for col in columnas_fecha:
        if col in df.columns:
            columnas_existentes.append(col)
            logger.info(f"  ‚úì {col}: encontrada")
        else:
            # Buscar variantes (con acentos, etc.)
            posibles_variantes = {
                "Fecha Creacion": ["Fecha Creaci√≥n", "Fecha_Creacion", "FechaCreacion"],
                "Fecha Enviado": ["Fecha_Enviado", "FechaEnviado"],
                "Fecha Asignacion": ["Fecha_Asignacion", "FechaAsignacion", "Fecha Asignaci√≥n"],
                "Fecha Atendido": ["Fecha_Atendido", "FechaAtendido"]
            }
            
            encontrada = False
            if col in posibles_variantes:
                for variante in posibles_variantes[col]:
                    if variante in df.columns:
                        # Renombrar para uniformidad
                        df = df.rename(columns={variante: col})
                        columnas_existentes.append(col)
                        logger.info(f"  ‚úì {variante} ‚Üí renombrada a {col}")
                        encontrada = True
                        break
            
            if not encontrada:
                logger.warning(f"  ‚ö†Ô∏è {col}: NO encontrada")
    
    logger.info(f"Total columnas de fecha a procesar: {len(columnas_existentes)}")

    # =========================
    # CONVERTIR COLUMNAS DE FECHA A DATETIME
    # =========================
    logger.info("\nüìÖ CONVIRTIENDO COLUMNAS DE FECHA A DATETIME...")
    
    for col in columnas_existentes:
        df = convertir_columna_fecha(df, col)

    # =========================
    # FILTRAR ESTATUS TRUE
    # =========================
    logger.info("\nüîç FILTRANDO POR ESTATUS = TRUE...")
    
    if "Estatus" in df.columns:
        filas_antes = len(df)
        df = df[df["Estatus"] == "True"].copy()
        filas_despues = len(df)
        logger.info(f"  Estatus='True' ‚Üí {filas_despues} filas (de {filas_antes})")
    else:
        logger.warning("‚ö†Ô∏è No se pudo encontrar columna 'Estatus'. Saltando filtro.")

    # =========================
    # LIMPIAR CIS / CIS_1
    # =========================
    logger.info("\nüßπ LIMPIANDO COLUMNAS CIS...")
    
    for col in ["CIS", "CIS_1"]:
        if col in df.columns:
            valores_antes = df[col].notna().sum()
            
            df[col] = (
                df[col]
                .astype(str)
                .str.replace(r"\D+", "", regex=True)
                .replace("nan", None)
                .replace("", None)
            )
            
            valores_despues = df[col].notna().sum()
            logger.info(f"  {col}: {valores_despues}/{valores_antes} valores despu√©s de limpiar")

    # =========================
    # CALCULAR TIEMPOS DE AGENTE Y ROBOT
    # =========================
    df = calcular_tiempos_agente_robot(df)

    # =========================
    # CALCULAR CATEGOR√çAS DE CARGOS (REVISADO)
    # =========================
    df = calcular_categorias_cargos(df)

    # =========================
    # OTRAS TRANSFORMACIONES
    # =========================
    logger.info("\n‚öôÔ∏è APLICANDO OTRAS TRANSFORMACIONES...")
    
    # Cambiar Estatus a "Exitoso"
    if "Estatus" in df.columns:
        df["Estatus"] = "Exitoso"
        logger.info("‚úì 'Estatus' cambiado a 'Exitoso'")
    
    # Renombrar columna de nombre agente si existe
    posibles_nombres_agente = ["NOMBRE", "Nombre", "nombre", "Agente", "agente", "Nombre Agente"]
    for nombre in posibles_nombres_agente:
        if nombre in df.columns:
            if nombre != "Nombre Agente":  # Solo renombrar si no es ya el nombre correcto
                df = df.rename(columns={nombre: "Nombre Agente"})
                logger.info(f"‚úì {nombre} ‚Üí renombrada a 'Nombre Agente'")
            break
    
    if "Nombre Agente" not in df.columns:
        logger.warning("‚ö†Ô∏è No se encontr√≥ columna para 'Nombre Agente'")
        df["Nombre Agente"] = None
    
    # Asegurar que la columna Site exista
    if "Site" not in df.columns:
        logger.warning("‚ö†Ô∏è No se encontr√≥ columna 'Site'. Creando columna vac√≠a...")
        df["Site"] = "Sin Site"

    # =========================
    # VERIFICAR COLUMNAS ANTES DE SELECCI√ìN
    # =========================
    logger.info("\nüîç VERIFICANDO COLUMNAS PARA SALIDA...")
    
    columnas_faltantes = []
    columnas_existentes = []
    
    for col in COLUMNAS_SALIDA:
        if col in df.columns:
            columnas_existentes.append(col)
        else:
            columnas_faltantes.append(col)
    
    logger.info(f"Columnas disponibles: {len(columnas_existentes)}/{len(COLUMNAS_SALIDA)}")
    
    if columnas_faltantes:
        logger.warning("Columnas faltantes:")
        for col in columnas_faltantes:
            logger.warning(f"  ‚ö†Ô∏è {col}")
        
        # Crear columnas faltantes vac√≠as
        for col in columnas_faltantes:
            df[col] = None
        logger.info("‚úì Columnas faltantes creadas como vac√≠as")

    # =========================
    # SELECCI√ìN FINAL Y ORDEN
    # =========================
    logger.info("\nüìã PREPARANDO DATAFRAME FINAL...")
    df_final = df[COLUMNAS_SALIDA].copy()
    
    # Ordenar por fecha si existe
    if "Fecha" in df_final.columns and df_final["Fecha"].notna().any():
        df_final = df_final.sort_values("Fecha", ascending=True)
        logger.info("‚úì Datos ordenados por 'Fecha'")
    
    logger.info(f"‚úì DataFrame final: {len(df_final)} filas √ó {len(df_final.columns)} columnas")

    # =========================
    # EXPORTAR EXCEL (SIN FORMATO INICIAL)
    # =========================
    logger.info(f"\nüì§ Exportando Excel (sin formato inicial): {OUTPUT_FILE}")
    
    # Exportar SIN ajustar columnas inicialmente
    with pd.ExcelWriter(
        OUTPUT_FILE,
        engine='openpyxl',
        date_format='yyyy-mm-dd hh:mm:ss'
    ) as writer:
        df_final.to_excel(
            writer,
            index=False,
            sheet_name='Reporte'
        )
    
    logger.info("‚úÖ Reporte Excel generado (sin formato)")
    logger.info(f"üìä Filas finales: {len(df_final)}")
    logger.info(f"üìÅ Ubicaci√≥n: {OUTPUT_FILE}")
    
    # =========================
    # CREAR HOJAS DE TIEMPO Y COMPARATIVA
    # =========================
    procesar_y_crear_hojas_tiempos(df_final, OUTPUT_FILE)
    
    # =========================
    # APLICAR FORMATO COMPLETO EN UNA SOLA PASADA
    # =========================
    aplicar_formato_completo_excel(OUTPUT_FILE)
    
    # Resumen final
    logger.info("\nüìã RESUMEN FINAL:")
    logger.info("="*60)
    logger.info(f"Archivo: {OUTPUT_FILE.name}")
    logger.info(f"Total filas: {len(df_final)}")
    
    # Mostrar nombres de hojas
    workbook = load_workbook(OUTPUT_FILE)
    hojas = workbook.sheetnames
    logger.info(f"Hojas creadas: {len(hojas)}")
    for hoja in hojas:
        logger.info(f"  - {hoja}")
    
    # Resumen de categor√≠as
    if "Categoria tiempo agente" in df_final.columns:
        total_cat = df_final["Categoria tiempo agente"].notna().sum()
        logger.info(f"Categor√≠as tiempo agente calculadas: {total_cat}")
    
    if "Categoria tiempo Alta robot" in df_final.columns:
        total_cat = df_final["Categoria tiempo Alta robot"].notna().sum()
        logger.info(f"Categor√≠as tiempo alta robot calculadas: {total_cat}")
        
        # Mostrar espec√≠ficamente intervenciones manuales
        intervenciones = df_final[df_final["Categoria tiempo Alta robot"] == "Intervenci√≥n manual (> 25min)"].shape[0]
        if intervenciones > 0:
            logger.info(f"üö® INTERVENCIONES MANUALES (>25min): {intervenciones} casos")
            porcentaje = (intervenciones / total_cat * 100) if total_cat > 0 else 0
            logger.info(f"   Representa el {porcentaje:.1f}% del total")
    
    if "Categoria de cargos" in df_final.columns:
        total_cat = df_final["Categoria de cargos"].notna().sum()
        logger.info(f"Categor√≠as de cargos calculadas: {total_cat}")
    
    logger.info("\nüéØ NUEVAS HERRAMIENTAS DISPONIBLES:")
    logger.info("1. Hoja 'Tiempo agente': Distribuci√≥n diaria de categor√≠as")
    logger.info("2. Hoja 'Tiempo robot': Distribuci√≥n diaria de categor√≠as")
    logger.info("3. Hoja 'Comparativa Agentes': An√°lisis por Site y Agente")
    logger.info("4. Gr√°ficas de COLUMNAS APILADAS + l√≠nea de totales")
    logger.info("5. Gr√°ficas muestran AUTOM√ÅTICAMENTE los √öLTIMOS 7 d√≠as")
    logger.info("6. Tablas con filtros para seleccionar rangos personalizados")
    logger.info("7. Gr√°ficas posicionadas al lado derecho de las tablas")
    logger.info("8. Barras de datos degradadas rojas en tabla comparativa")
    
    logger.info("\nüîß C√ìMO USAR LOS FILTROS:")
    logger.info("- Haz clic en los filtros de la columna 'Fecha'")
    logger.info("- Selecciona el rango de fechas que deseas analizar")
    logger.info("- La gr√°fica se actualizar√° autom√°ticamente con la selecci√≥n")
    
    logger.info("\nüìä HOJA 'COMPARATIVA AGENTES':")
    logger.info("- Tabla 1: Casos por Site y d√≠a")
    logger.info("- Tabla 2: Casos por Agente y d√≠a")
    logger.info("- Barras rojas degradadas muestran distribuci√≥n")
    logger.info("- Filtros en encabezados para ordenar datos")
    
    logger.info("\n‚úÖ PROCESO COMPLETADO EXITOSAMENTE")
    logger.info("="*60)

# =========================
# EJECUCI√ìN
# =========================
if __name__ == "__main__":
    main()
